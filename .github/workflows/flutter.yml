name: Update Web Branch

on:
  push:
    branches:
      - main

jobs:
  update-web:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Main Branch
      uses: actions/checkout@v3
      with:
        repository: Icarus-conf/fc_lang
        ref: main

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.13.0'

    - name: Install Dependencies
      run: flutter pub get

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-artifacts
        path: build/web


    - name: Build Flutter Web
      run: flutter build web --release --no-tree-shake-icons

    - name: Check Build Directory
      run: |
        echo "Listing build directory:"
        ls -la build
        echo "Listing build/web directory:"
        if [ -d "build/web" ]; then
          ls -la build/web
        else
          echo "Directory build/web does not exist."
          exit 1
        fi

    - name: Create or Checkout Web Branch
      run: |
        git fetch --all
        if git show-ref --verify --quiet refs/heads/web-branch; then
          git checkout web-branch
        else
          git checkout -b web-branch
        fi

    - name: Copy Built Files to Web Branch
      run: |
        if [ -d "build/web" ]; then
          echo "Copying build/web contents to web branch"
          rm -rf *  # clear the web branch directory
          cp -R build/web/* .
          git add .
          git commit -m "Update web branch with latest changes from main"
          git push origin web-branch
        else
          echo "Build directory does not exist. Skipping file copy."
          exit 1
        fi

    - name: Deploy to GitHub Pages
      run: |
        git checkout -B gh-pages
        git add .
        git commit -m "Deploy to GitHub Pages"
        git push --force origin gh-pages
